<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>DeepSeek Chat by é£æ‰‡</title>

<!-- highlight.js for client-side syntax highlighting -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>

<style>
  :root{
    --bg:#0F1113;
    --panel:#191B1E;
    --muted:#8b949e;
    --bubble:#242628;
    --accent:#0066CC;
    --radius:14px;
    --safe-bottom: env(safe-area-inset-bottom, 12px);
    --bottom-height: 76px; /* åŸºç¡€åº•éƒ¨ç©ºé—´, ä¼šåœ¨ runtime åŠ¨æ€è°ƒæ•´ */
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#e6eef6;font-family: Inter, "Helvetica Neue", Arial, sans-serif;-webkit-font-smoothing:antialiased}
  .app{display:flex;flex-direction:column;min-height:100vh;gap:0}
  header{padding:14px 12px;background:var(--panel);border-bottom:1px solid rgba(255,255,255,0.05);display:flex;justify-content:space-between;align-items:center}
  .ai-box{display:flex;flex-direction:column}
  .ai-title{
    font-weight:600;font-size:16px;letter-spacing:0.2px;display:flex;align-items:center;
  }
  .signature{font-size:12px;color:var(--muted);margin-top:4px}
  main{flex:1;overflow:auto;padding:16px;padding-bottom:calc(var(--bottom-height) + var(--safe-bottom));display:flex;flex-direction:column;gap:12px}
  .messages{display:flex;flex-direction:column;gap:12px;align-items:stretch}
  .msg{max-width:78%;padding:10px 12px;border-radius:12px;font-size:15px;line-height:1.45;word-break:break-word;white-space:pre-wrap;background:var(--bubble)}
  .msg.user{margin-left:auto;text-align:left}
  .msg.ai{margin-right:auto;text-align:left}
  .meta{font-size:12px;color:var(--muted);margin-bottom:6px;display:flex;flex-direction:column;align-items:flex-start;gap:4px}
  .nick{font-weight:700;color:#fff;display:flex;align-items:center}
  /* æ‰“å­—åŠ¨ç”»å°ç‚¹ç‚¹ï¼šæ”¾åœ¨æ˜µç§°ä¸‹é¢ */
  .typing-dots{display:inline-flex;gap:6px;margin-top:2px}
  .typing-dots span{width:6px;height:6px;background:var(--muted);border-radius:50%;display:inline-block;animation:blink 1.4s infinite}
  .typing-dots span:nth-child(2){animation-delay:0.2s}
  .typing-dots span:nth-child(3){animation-delay:0.4s}
  @keyframes blink{0%,80%,100%{opacity:.3}40%{opacity:1}}
  /* spacerï¼šç¡®ä¿æœ€åæ¶ˆæ¯ä¸ä¼šè¢«å›ºå®šåº•éƒ¨è¦†ç›– */
  .messages-spacer{height:var(--bottom-height);flex-shrink:0}
  /* å›ºå®šåº•éƒ¨ï¼ŒåŠ¨æ€è°ƒæ•´ bottom å€¼ç”±è„šæœ¬æ§åˆ¶ä»¥é€‚é…é”®ç›˜ */
  .bottom{position:fixed;left:0;right:0;padding:12px 12px calc(12px + var(--safe-bottom));backdrop-filter: blur(6px);background:var(--panel);border-top:1px solid rgba(255,255,255,0.05);z-index:8;transition:bottom 160ms ease}
  .composer{display:flex;gap:8px;align-items:center}
  textarea#input{flex:1;min-height:44px;max-height:240px;border-radius:12px;border:1px solid rgba(255,255,255,0.08);background:#1a1c1e;padding:12px 14px;color:#e6eef6;resize:none;font-size:15px;overflow-y:auto;line-height:1.4;transition:width 160ms ease,height 160ms ease,padding 160ms ease}
  .send-btn{background:var(--accent);color:white;padding:10px 12px;border-radius:12px;border:none;font-weight:600;cursor:pointer}
  .settings-btn,.clear-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px;margin-left:8px}
  /* å¼¹çª— */
  .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;z-index:10}
  .modal-content{background:var(--panel);padding:18px;border-radius:var(--radius);width:92%;max-width:520px;box-shadow:0 0 10px rgba(0,0,0,0.4);display:flex;flex-direction:column;gap:6px}
  .modal-content h2{margin:0 0 8px 0;font-size:18px}
  /* label + input å¯¹é½ï¼Œæ‰€æœ‰è¾“å…¥å‡å æ»¡å®½åº¦ */
  .modal-row{display:flex;flex-direction:column;gap:6px;}
  .modal-content label{color:var(--muted);font-size:13px}
  .modal-content input[type="text"], .modal-content input[type="search"], .modal-content input[type="password"]{
    width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:#0F1113;color:#e6eef6;outline:none;box-sizing:border-box;
  }
  /* è‡ªå®šä¹‰æç¤ºè¯æ”¹ä¸º textareaï¼Œç”¨äºå¤§æ®µæ–‡å­—ï¼Œä½†ä¿æŒä¸å…¶å®ƒè¾“å…¥å¯¹é½ */
  .modal-content textarea{width:100%;min-height:120px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:#0F1113;color:#e6eef6;outline:none;box-sizing:border-box;resize:vertical}
  .modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:8px}
  .btn{padding:8px 12px;border:none;border-radius:8px;cursor:pointer;font-weight:600}
  .btn.save{Background:var(--accent);color:#fff}
  .btn.close{background:#333;color:#ccc}
  /* å¾®è°ƒæ¶ˆæ¯å®¹å™¨æ»šåŠ¨å¹³æ»‘ */
  main, .messages {scroll-behavior: smooth;}

  /* ======= Markdown & code block styles (è°ƒæ•´ä¸ºæ›´ç´§å‡‘) ======= */
  .msg pre {
    background: #0b0c0d;
    border-radius:8px;
    padding:12px;
    margin:6px 0;
    overflow:auto;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Helvetica Neue", monospace;
    font-size:13px;
    line-height:1.45;
    border:1px solid rgba(255,255,255,0.04);
    white-space:pre; /* code é«˜äº®æ›´å‡†ç¡® */
    word-break:normal;
    position:relative; /* ä¸ºå³ä¸Šè§’æŒ‰é’®å®šä½ */
  }
  .msg code.inline {
    background: rgba(255,255,255,0.03);
    padding:2px 6px;
    border-radius:6px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Helvetica Neue", monospace;
    font-size:13px;
  }

  /* small adjustments for headings / paragraphs to reduce large gaps */
  .msg h1, .msg h2, .msg h3, .msg h4 {
    margin:8px 0 6px;
    color:#fff;
  }
  .msg p{margin:6px 0}
  .msg ul{margin:6px 0 8px 18px;padding:0}
  .msg ol{margin:6px 0 8px 18px;padding:0}
  .msg li{margin:6px 0}
  .msg blockquote{
    margin:6px 0;padding:8px 12px;border-left:3px solid rgba(255,255,255,0.06);
    color:var(--muted);background:rgba(255,255,255,0.02);border-radius:8px;
  }
  .msg a{color:var(--accent);text-decoration:none}
  .msg a:hover{text-decoration:underline}

  /* copy button (åŠé€æ˜åœ†è§’ç°è‰²) */
  .code-controls {
    position:absolute;
    top:8px;
    right:8px;
    display:flex;
    gap:6px;
    align-items:center;
    z-index:5;
  }
  .copy-btn {
    background: rgba(255,255,255,0.06);
    color: #e6eef6;
    border: none;
    padding:6px 8px;
    border-radius:8px;
    font-size:12px;
    cursor:pointer;
    backdrop-filter: blur(4px);
  }
  .copy-btn:active { transform: translateY(1px); }
  .lang-badge {
    background: rgba(255,255,255,0.03);
    color: var(--muted);
    padding:4px 6px;
    border-radius:8px;
    font-size:11px;
  }

  @media (max-height:600px){
    .modal-content{max-height:80vh;overflow:auto}
  }

  /* ====== æ€ç»´é“¾ (reasoning) æ ·å¼ ====== */
  .reasoning-box {
    margin-top:8px;
    background: rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.03);
    padding:10px;
    border-radius:10px;
    color:var(--muted);
    font-size:13px;
    line-height:1.45;
    /* ç¡®ä¿å±•å¼€æ—¶æ²¡æœ‰é˜´å½± */
    box-shadow: none;
  }
  .reasoning-toggle {
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    margin-top:8px;
  }
  .reasoning-toggle button {
    background: transparent;
    color: var(--muted);
    border:1px solid rgba(255,255,255,0.04);
    padding:6px 8px;
    border-radius:8px;
    cursor:pointer;
    font-size:12px;
  }
  .reason-label { font-size:12px;color:var(--muted); }
  /* æŠ˜å çŠ¶æ€ï¼šå®Œå…¨éšè—ï¼ˆä¸æ˜¾ç¤ºé¢„è§ˆã€ä¸åŠ æ¸å˜ï¼‰ */
  .reasoning-collapsed {
    display: none;
  }

  /* è¾“å…¥æ¡† collapsed çŠ¶æ€ï¼ˆæœªèšç„¦ï¼‰ */
  textarea.collapsed {
    width: 160px; /* æ”¶èµ·æ—¶è¾ƒçª„ï¼Œå’Œå‘é€æŒ‰é’®åœ¨ä¸€è¡Œå¯¹é½ï¼Œè§†è§‰æ›´ç®€æ´ */
    padding-top:8px;
    padding-bottom:8px;
    height:44px;
  }
  /* èšç„¦æ—¶æ¢å¤ flex:1 */
  textarea.expanded {
    width: auto;
    flex:1;
  }
  /* small device tweak: æ”¶èµ·å®½åº¦ä¸è¦å¤ªçª„ */
  @media (max-width:420px){
    textarea.collapsed { width: 120px; }
  }

  /* Toggle è¡Œå†…æ ·å¼ï¼ˆç”¨ç±»ä»£æ›¿å†…è”æ ·å¼ï¼Œä¿è¯ä¸ä¸Šä¸€ä¸ªé€‰é¡¹çš„å‚ç›´é—´è·ç”± .modal-row æ§åˆ¶ï¼‰ */
  .toggle-row{display:flex;align-items:center;gap:10px;}
  .toggle-desc{color:var(--muted);font-size:13px}
  /* ---------- Sessions list small tweaks (kept minimal) ---------- */
  .sessions-list { display:flex;flex-direction:column;gap:8px; margin-top:8px; }
  .session-item { display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02); }
  .session-item .left { display:flex;flex-direction:column; gap:2px; }
  .session-item .name { font-weight:700; color:#fff; font-size:14px; }
  .session-item .meta { font-size:12px; color:var(--muted); }
  .session-actions { display:flex; gap:6px; align-items:center; }
  .session-actions button { background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.03); padding:6px 8px; border-radius:8px; cursor:pointer; font-size:12px; }
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="ai-box">
      <div class="ai-title" id="headerTitle">
        <div id="aiTitleText">å’ŒdeepseekèŠå¤©ï¼</div>
      </div>
      <div class="signature" id="signature"></div>
    </div>
    <div>
      <!-- åŸâ€œæ¸…ç©ºâ€æŒ‰é’®æ”¹ä¸ºâ€œæ–°å»ºä¼šè¯â€æŒ‰é’®ï¼ˆä¿ç•™ id clearHistory ä»¥å‡å°‘ JS æ”¹åŠ¨ï¼‰ -->
      <button class="clear-btn" id="clearHistory" title="æ–°å»ºä¼šè¯">â•</button>
      <!-- æ–°å¢ï¼šæ‰“å¼€ä¼šè¯ç®¡ç† -->
      <button class="settings-btn" id="openSessions" title="ä¼šè¯ç®¡ç†">ğŸ“‚</button>
      <button class="settings-btn" id="openSettings" title="è®¾ç½®">âš™ï¸</button>
    </div>
  </header>
  <main>
    <div class="messages" id="messages"></div>
  </main>
  <div class="bottom" id="bottom">
    <div class="composer">
      <textarea id="input" placeholder="Enter your text." rows="1" aria-label="æ¶ˆæ¯è¾“å…¥"></textarea>
      <button id="send" class="send-btn">å‘é€</button>
    </div>
  </div>
</div>

    <!-- è®¾ç½®å¼¹çª—ï¼ˆä¿ç•™ AI æ˜µç§°ã€ä¸ªæ€§ç­¾åä¸è‡ªå®šä¹‰æç¤ºè¯ï¼Œå¹¶æ–°å¢ API Key ä¸æ€è€ƒå¼€å…³ï¼‰ -->
<div class="modal" id="settingsModal">
  <div class="modal-content">
    <h2>è®¾ç½®</h2>
    <div class="modal-row">
      <label for="aiNick">æ˜µç§° Name</label>
      <input id="aiNick" type="text" value="å°é£" />
    </div>

    <div class="modal-row">
      <label for="signatureInput">ä¸ªç­¾ Introduction</label>
      <input id="signatureInput" type="text" placeholder="ä¾‹å¦‚ï¼šFly to the sky" />
    </div>

    <div class="modal-row">
      <label for="userPrompt">æ€§æ ¼ Character</label>
      <textarea id="userPrompt" placeholder="å®šä¹‰AIçš„æ€§æ ¼ã€è¯´è¯æ–¹å¼ï¼ˆåœ¨è¿™é‡Œé‡å¤AIçš„åå­—"></textarea>
    </div>

    <div class="modal-row">
      <label for="apiKeyInput">API Keyï¼ˆæœ¬åœ°ä¿å­˜ï¼‰</label>
      <input id="apiKeyInput" type="password" placeholder="sk-xxxxxxxxx" />
    </div>

    <div class="modal-row">
      <label for="reasoningToggle">æ·±åº¦æ€è€ƒ</label>
      <div class="toggle-row">
        <input id="reasoningToggle" type="checkbox" />
        <div class="toggle-desc">å¼€å¯åå°†æ·±åº¦æ€è€ƒ</div>
      </div>
    </div>

    <!-- æ–°å¢é¡¹ï¼šé»˜è®¤æŠ˜å æ€ç»´é“¾ -->
    <div class="modal-row">
      <div class="toggle-row">
        <input id="defaultReasonCollapsedToggle" type="checkbox" />
        <div class="toggle-desc">å¼€å¯åå°†é»˜è®¤ä¸å±•ç¤ºæ€ç»´é“¾</div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn close" id="closeSettings">å–æ¶ˆ</button>
      <button class="btn save" id="saveSettings">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ä¼šè¯ç®¡ç†å¼¹çª—ï¼ˆå·²åˆ é™¤åŸæœ‰çš„â€œæ–°å»ºâ€è¾“å…¥åŒºï¼Œæ–°å»ºæ”¹ä¸º header ä¸Šçš„æŒ‰é’®ï¼‰ -->
<div class="modal" id="sessionsModal">
  <div class="modal-content">
    <h2>ä¼šè¯ç®¡ç†</h2>

    <div class="sessions-list" id="sessionsList"></div>

    <div class="modal-actions">
      <button class="btn close" id="closeSessions">å…³é—­</button>
    </div>
  </div>
</div>

<script>

const API_BASE = "https://api.deepseek.com";
const MODEL_CHAT = "deepseek-chat";
const MODEL_REASONER = "deepseek-reasoner";

// æ—§å•ä¼šè¯å­˜å‚¨ keyï¼ˆå…¼å®¹è¿ç§»ï¼‰
const STORAGE_KEY = "deepseek_chat_autosave";
// æ–°çš„å¤šä¼šè¯å­˜å‚¨ï¼ˆmapping id -> session objï¼‰
const SESSIONS_KEY = "deepseek_chat_sessions_v1";
const CURRENT_SESSION_KEY = "deepseek_chat_current_session_v1";
const SETTINGS_KEY = "deepseek_chat_settings";

const msgsEl = document.getElementById("messages");
const inputEl = document.getElementById("input");
const sendBtn = document.getElementById("send");
const aiNickEl = document.getElementById("aiNick");
const aiTitleTextEl = document.getElementById("aiTitleText");
const signatureEl = document.getElementById("signature");
const signatureInputEl = document.getElementById("signatureInput");
const userPromptEl = document.getElementById("userPrompt");
const apiKeyEl = document.getElementById("apiKeyInput");
const reasoningToggleEl = document.getElementById("reasoningToggle");
const defaultReasonCollapsedToggleEl = document.getElementById("defaultReasonCollapsedToggle");

const settingsModal = document.getElementById("settingsModal");
const openSettingsBtn = document.getElementById("openSettings");
const closeSettingsBtn = document.getElementById("closeSettings");
const saveSettingsBtn = document.getElementById("saveSettings");
const clearHistoryBtn = document.getElementById("clearHistory"); // now acts as "æ–°å»ºä¼šè¯"
const bottomEl = document.getElementById("bottom");
const headerTitle = document.getElementById("headerTitle");

// sessions modal elements
const openSessionsBtn = document.getElementById("openSessions");
const sessionsModal = document.getElementById("sessionsModal");
const closeSessionsBtn = document.getElementById("closeSessions");
// (åŸ modal ä¸­çš„æ–°å»ºè¾“å…¥å·²åˆ é™¤)
const sessionsListEl = document.getElementById("sessionsList");

let messages = []; // å½“å‰ä¼šè¯çš„ messages
let currentSession = null; // {id,name,createdAt,updatedAt,messages}

/* ------------------ Sessions ç®¡ç†ï¼ˆå¤šä¼šè¯å®ç°æ ¸å¿ƒï¼‰ ------------------ */

function loadAllSessions(){
  try{
    const raw = localStorage.getItem(SESSIONS_KEY);
    if(!raw) return {};
    return JSON.parse(raw) || {};
  }catch(e){
    return {};
  }
}
function saveAllSessions(obj){
  localStorage.setItem(SESSIONS_KEY, JSON.stringify(obj || {}));
}

function getCurrentSessionId(){
  return localStorage.getItem(CURRENT_SESSION_KEY) || null;
}
function setCurrentSessionId(id){
  if(id) localStorage.setItem(CURRENT_SESSION_KEY, id);
  else localStorage.removeItem(CURRENT_SESSION_KEY);
}

// è¿ç§»æ—§æ•°æ®ï¼ˆå¦‚æœå­˜åœ¨ STORAGE_KEY çš„æ•°æ®ï¼‰åˆ° sessions ä¸­ï¼ˆåªåœ¨é¦–æ¬¡åŠ è½½æ—¶è°ƒç”¨ï¼‰
function migrateLegacyStorageIfNeeded(){
  try{
    const legacy = localStorage.getItem(STORAGE_KEY);
    if(!legacy) return;
    // å¦‚æœå·²ç»æœ‰ sessions å­˜åœ¨ï¼Œè·³è¿‡è¿ç§»ï¼ˆé¿å…è¦†ç›–ï¼‰
    const all = loadAllSessions();
    if(Object.keys(all).length > 0) return;
    // ä½œä¸ºä¸€ä¸ªé»˜è®¤ä¼šè¯è¿ç§»
    let parsed = [];
    try{ parsed = JSON.parse(legacy) || []; }catch(e){ parsed = []; }
    const id = `s_${Date.now()}_${Math.floor(Math.random()*1000)}`;
    const session = {
      id,
      name: "é»˜è®¤ä¼šè¯",
      createdAt: Date.now(),
      updatedAt: Date.now(),
      messages: parsed
    };
    all[id] = session;
    saveAllSessions(all);
    setCurrentSessionId(id);
    // æ¸…ç†æ—§çš„ keyï¼ˆä½†ä¿ç•™ä»¥é˜²è¯¯åˆ â€”æ­¤å¤„æˆ‘ä¿ç•™ä¸åˆ é™¤ï¼Œé¿å…ç ´åç”¨æˆ·æœŸå¾…ï¼‰
    // localStorage.removeItem(STORAGE_KEY);
  }catch(e){}
}

// create new session
function createSession(name){
  const all = loadAllSessions();
  const id = `s_${Date.now()}_${Math.floor(Math.random()*1000)}`;
  const session = {
    id,
    name: name && name.trim() ? name.trim() : `ä¼šè¯ ${Object.keys(all).length + 1}`,
    createdAt: Date.now(),
    updatedAt: Date.now(),
    messages: []
  };
  all[id] = session;
  saveAllSessions(all);
  setCurrentSessionId(id);
  loadCurrentSession(); // set currentSession and messages
  renderSessionsList();
  renderMessages();
  return session;
}

// delete session
function deleteSession(id){
  const all = loadAllSessions();
  if(!all[id]) return;
  delete all[id];
  saveAllSessions(all);
  // if deleted current -> switch to another or create new
  if(currentSession && currentSession.id === id){
    const keys = Object.keys(all);
    if(keys.length > 0){
      setCurrentSessionId(keys[0]);
    } else {
      // create a new empty session
      const s = createSession("ä¼šè¯ 1");
      setCurrentSessionId(s.id);
    }
    loadCurrentSession();
  }
  renderSessionsList();
  renderMessages();
}

// rename session
function renameSession(id, newName){
  const all = loadAllSessions();
  if(!all[id]) return;
  all[id].name = newName;
  all[id].updatedAt = Date.now();
  saveAllSessions(all);
  if(currentSession && currentSession.id === id){
    currentSession.name = newName;
    headerTitleUpdate();
  }
  renderSessionsList();
}

// switch to session id
function switchToSession(id){
  const all = loadAllSessions();
  if(!all[id]) return;
  setCurrentSessionId(id);
  loadCurrentSession();
  renderSessionsList();
  renderMessages();
}

// load current session (reads localStorage)
function loadCurrentSession(){
  const all = loadAllSessions();
  let id = getCurrentSessionId();
  if(!id || !all[id]){
    // pick first session if exists, else create one
    const keys = Object.keys(all);
    if(keys.length > 0){
      id = keys[0];
      setCurrentSessionId(id);
    } else {
      const s = createSession("é»˜è®¤ä¼šè¯");
      id = s.id;
    }
  }
  currentSession = all[id];
  // ensure messages array exists
  messages = Array.isArray(currentSession.messages) ? currentSession.messages : [];
  headerTitleUpdate();
}

/* save currentSession.messages back to storage (called whenever messages change) */
function saveCurrentSession(){
  try{
    if(!currentSession) return;
    const all = loadAllSessions();
    // update currentSession fields
    currentSession.updatedAt = Date.now();
    currentSession.messages = messages;
    all[currentSession.id] = currentSession;
    saveAllSessions(all);
    // for backward compatibility also save to old STORAGE_KEY (optional)
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(messages)); }catch(e){}
    // also persist settings
    // After saving, try to auto-summarize session title using AI (non-blocking)
    try{
      // only summarize when there is at least one user/assistant message
      if(messages && messages.length > 0){
        // === å…³é”®ä¿®æ”¹ START ===
        // ä¸ºäº†èŠ‚çœ API Keyï¼šä»…åœ¨ä¼šè¯å‰ 3 æ¡æœ‰æ„ä¹‰æ¶ˆæ¯æ—¶ï¼ˆ<=3ï¼‰å°è¯•è‡ªåŠ¨æ€»ç»“æ ‡é¢˜ï¼Œ
        // è¶…è¿‡ 3 æ¡æ¶ˆæ¯åå°†æŠŠä¼šè¯æ ‡è®°ä¸º titleFinalizedï¼Œä¸å†è°ƒç”¨ AI æ€»ç»“ã€‚
        // "æœ‰æ„ä¹‰" æŒ‡ role ä¸º user/assistantï¼Œä¸”ä¸æ˜¯å ä½ _typing çš„æ¶ˆæ¯ã€‚
        const relevantCount = messages.filter(m => (m.role === "user" || m.role === "assistant") && m.content !== "_typing" && String(m.content||"").trim()).length;

        // å¦‚æœæœ‰ä»»ä½• assistant æ¶ˆæ¯ä»åœ¨æµå¼è¾“å‡ºï¼ˆstreamingï¼‰ï¼Œåˆ™è·³è¿‡æœ¬æ¬¡æ€»ç»“ï¼ˆç­‰å¾…æµç»“æŸè§¦å‘æœ€ç»ˆä¿å­˜æ—¶å†å°è¯•ï¼‰
        const anyStreaming = messages.some(m => m.role === "assistant" && !!m.streaming);
        if(!currentSession.titleFinalized && !anyStreaming){
          if(relevantCount <= 3){
            // ä»åœ¨å‰ä¸‰æ¡å†…ï¼šå°è¯•ç”Ÿæˆæ‘˜è¦æ ‡é¢˜ï¼ˆå¼‚æ­¥ï¼‰
            summarizeSessionTitle(currentSession.id);
          } else {
            // è¶…è¿‡ä¸‰æ¡ï¼šæ ‡è®°ä¸º finalizedï¼Œåç»­ä¸å†è°ƒç”¨ summarize
            currentSession.titleFinalized = true;
            // persist this change
            all[currentSession.id] = currentSession;
            saveAllSessions(all);
          }
        }
        // === å…³é”®ä¿®æ”¹ END ===
      }
    }catch(e){}
  }catch(e){}
}

/* render sessions list in modal */
function renderSessionsList(){
  const all = loadAllSessions();
  const arr = Object.values(all).sort((a,b)=> b.updatedAt - a.updatedAt);
  sessionsListEl.innerHTML = "";
  for(const s of arr){
    const item = document.createElement("div");
    item.className = "session-item";
    const left = document.createElement("div");
    left.className = "left";
    const name = document.createElement("div");
    name.className = "name";
    name.textContent = s.name + (currentSession && currentSession.id === s.id ? " (å½“å‰)" : "");
    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = `æ¶ˆæ¯ ${Array.isArray(s.messages)?s.messages.length:0} â€¢ ${new Date(s.updatedAt).toLocaleString()}`;
    left.appendChild(name);
    left.appendChild(meta);
    const actions = document.createElement("div");
    actions.className = "session-actions";

    const openBtn = document.createElement("button");
    openBtn.textContent = "æ‰“å¼€";
    openBtn.addEventListener("click", ()=> {
      switchToSession(s.id);
      sessionsModal.style.display = "none";
    });
    actions.appendChild(openBtn);

    const renameBtn = document.createElement("button");
    renameBtn.textContent = "é‡å‘½å";
    renameBtn.addEventListener("click", ()=> {
      const nn = prompt("è¯·è¾“å…¥æ–°çš„ä¼šè¯åç§°ï¼š", s.name);
      if(nn && nn.trim()) renameSession(s.id, nn.trim());
    });
    actions.appendChild(renameBtn);

    const delBtn = document.createElement("button");
    delBtn.textContent = "åˆ é™¤";
    delBtn.addEventListener("click", ()=> {
      if(confirm(`ç¡®å®šåˆ é™¤ä¼šè¯ "${s.name}" å—ï¼Ÿï¼ˆåˆ é™¤åä¸å¯æ¢å¤ï¼‰`)) {
        deleteSession(s.id);
      }
    });
    actions.appendChild(delBtn);

    item.appendChild(left);
    item.appendChild(actions);
    sessionsListEl.appendChild(item);
  }
}

/* ------------------ Markdown helpers (å®‰å…¨ã€è½»é‡ã€æ”¹è¿›) ------------------ */
function escapeHtml(str){
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;");
}

/**
 * æå–ä»£ç å—ï¼ˆæ”¯æŒæœªé—­åˆçš„èµ·å§‹ ```ï¼šæŠŠå‰©ä½™å½“ code å†…å®¹ï¼‰
 * è¿”å› {text: replacedText, codeBlocks: [...]}
 */
function extractCodeBlocksRaw(text){
  const codeBlocks = [];
  let out = "";
  let pos = 0;
  while(true){
    const start = text.indexOf("```", pos);
    if(start === -1){
      out += text.slice(pos);
      break;
    }
    // append before fence
    out += text.slice(pos, start);
    // find matching end
    const end = text.indexOf("```", start + 3);
    const between = (end === -1) ? text.slice(start + 3) : text.slice(start + 3, end);
    // detect optional language on first line
    const m = between.match(/^([^\n]*)\n([\s\S]*)$/);
    let lang = "", code = "";
    if(m){
      lang = m[1].trim();
      code = m[2];
    } else {
      // æ²¡æœ‰æ˜ç¡®çš„è¯­è¨€è¡Œï¼ŒæŠŠæ•´ä¸ª between è§†ä¸º code å†…å®¹ï¼ˆå¯èƒ½åŒ…æ‹¬ single-line codeï¼‰
      lang = "";
      code = between;
    }
    const idx = codeBlocks.length;
    codeBlocks.push({lang, code});
    out += `@@CODEBLOCK_${idx}@@`;
    if(end === -1){
      // æœªé—­åˆï¼Œå·²ç»æ¶ˆè´¹åˆ°æ–‡æœ¬æœ«å°¾ï¼Œé€€å‡º
      pos = text.length;
      break;
    } else {
      pos = end + 3;
      continue;
    }
  }
  return {text: out, codeBlocks};
}

/**
 * å°†ç®€æ˜“ Markdown è½¬ä¸ºå®‰å…¨çš„ HTMLï¼ˆæ”¯æŒä»£ç å—ã€è¡Œå†…ä»£ç ã€ç²—ä½“ã€æ–œä½“ã€æ ‡é¢˜ã€åˆ—è¡¨ã€é“¾æ¥ã€å¼•ç”¨ã€è¡¨æ ¼ï¼‰
 * - å…ˆæŠ½å–ä»£ç å—å ä½ï¼Œé˜²æ­¢è¢«è½¬ä¹‰æˆ–è¯¯è§£æ
 * - å°†è¿ç»­çš„æ™®é€šæ–‡æœ¬åˆå¹¶ä¸ºæ®µè½ï¼ˆæ›´ç´§å‡‘ï¼‰
 */
function markdownToHtml(input){
  if(input === null || input === undefined) return "";

  // æ ‡å‡†åŒ–æ¢è¡Œ
  let text = String(input).replace(/\r\n/g, "\n");

  // æŠ½å–ä»£ç å—ï¼ˆæ”¯æŒæœªé—­åˆï¼‰
  const extracted = extractCodeBlocksRaw(text);
  text = extracted.text;
  const codeBlocks = extracted.codeBlocks;

  // åˆ†è¡Œå¤„ç†ï¼ˆåˆå¹¶è¿ç»­è¡Œåˆ°ä¸€ä¸ª <p>ï¼‰
  const lines = text.split("\n");
  const outParts = [];
  let paragraph = null;
  let inUl = false, inOl = false;

  function flushParagraph(){
    if(paragraph !== null){
      outParts.push(`<p>${paragraph}</p>`);
      paragraph = null;
    }
  }

  for(let i = 0; i < lines.length; i++){
    let line = lines[i];

    // heading
    const headingMatch = line.match(/^(#{1,6})\s+(.*)$/);
    if(headingMatch){
      flushParagraph();
      if(inUl){ outParts.push("</ul>"); inUl = false; }
      if(inOl){ outParts.push("</ol>"); inOl = false; }
      const level = headingMatch[1].length;
      outParts.push(`<h${level}>${inlineFormatting(escapeHtml(headingMatch[2]))}</h${level}>`);
      continue;
    }

    // table detection (æ”¯æŒ Markdown é£æ ¼è¡¨æ ¼ï¼š| a | b |, ä¸‹ä¸€è¡Œæ˜¯ --- | --- |)
    // éœ€è¦å½“å‰è¡ŒåŒ…å« '|' ä¸”ä¸‹ä¸€è¡Œæ˜¯åˆ†éš”çº¿
    if(line.indexOf('|') !== -1 && i + 1 < lines.length){
      const sepLine = lines[i+1];
      // ç®€å•æ£€æµ‹åˆ†éš”è¡Œï¼šç”± - : æˆ–ç©ºç™½ å’Œ | ç»„æˆï¼Œè‡³å°‘ä¸€ä¸ªç«–çº¿
      const sepMatch = sepLine.match(/^\s*\|?\s*(:?-+:?\s*)(\|\s*:?-+:?\s*)+\|?\s*$/);
      if(sepMatch){
        flushParagraph();
        if(inUl){ outParts.push("</ul>"); inUl = false; }
        if(inOl){ outParts.push("</ol>"); inOl = false; }

        // è§£æè¡¨å¤´
        function splitRow(row){
          // ä¿æŒå•å…ƒæ ¼é¡ºåºï¼›å…è®¸è¡Œé¦–/è¡Œå°¾æ—  | çš„æƒ…å†µ
          const parts = row.split('|').map(s => s.trim());
          // å¦‚æœé¦–å°¾æœ‰ç©ºé¡¹ï¼ˆå› ä¸ºä¸¤ä¾§æœ‰ |ï¼‰ï¼Œå»é™¤ç©ºçš„ç¬¬ä¸€æˆ–æœ€åé¡¹
          if(parts.length > 0 && parts[0] === "") parts.shift();
          if(parts.length > 0 && parts[parts.length-1] === "") parts.pop();
          return parts;
        }
        const headerCells = splitRow(line);
        // å¼€å§‹æ”¶é›† body è¡Œï¼Œä» i+2 å¼€å§‹ï¼Œç›´åˆ°é‡åˆ°ç©ºè¡Œæˆ–ä¸åŒ…å« '|'
        const bodyRows = [];
        let j = i + 2;
        for(; j < lines.length; j++){
          const r = lines[j];
          if(r.trim() === "") break;
          // å½“è¡Œä¸å« '|' æˆ–çœ‹èµ·æ¥ä¸æ˜¯è¡¨æ ¼ï¼ˆé¿å…æŠŠæ™®é€šå«ç«–çº¿æ–‡æœ¬è¯¯åˆ¤ï¼‰ï¼Œåœæ­¢
          if(r.indexOf('|') === -1) break;
          bodyRows.push(splitRow(r));
        }

        // æ„å»º HTML tableï¼ˆæ³¨æ„ï¼šå•å…ƒæ ¼å†…å®¹éœ€è¦ escape å¹¶åšè¡Œå†…æ ¼å¼å¤„ç†ï¼‰
        let tableHtml = "<table>";
        // thead
        tableHtml += "<thead><tr>";
        for(const hc of headerCells){
          tableHtml += `<th>${inlineFormatting(escapeHtml(hc))}</th>`;
        }
        tableHtml += "</tr></thead>";
        // tbody
        if(bodyRows.length){
          tableHtml += "<tbody>";
          for(const brow of bodyRows){
            tableHtml += "<tr>";
            for(const cell of brow){
              tableHtml += `<td>${inlineFormatting(escapeHtml(cell))}</td>`;
            }
            tableHtml += "</tr>";
          }
          tableHtml += "</tbody>";
        }
        tableHtml += "</table>";
        outParts.push(tableHtml);

        // advance i åˆ°æœ€åå¤„ç†çš„è¡Œï¼ˆj-1 æ˜¯æœ€åè¡¨æ ¼è¡Œï¼‰
        i = j - 1;
        continue;
      }
    }

    // blockquote
    if(line.trim().startsWith(">")){
      flushParagraph();
      if(inUl){ outParts.push("</ul>"); inUl = false; }
      if(inOl){ outParts.push("</ol>"); inOl = false; }
      const inner = line.replace(/^\s*>\s?/, "");
      outParts.push(`<blockquote>${inlineFormatting(escapeHtml(inner))}</blockquote>`);
      continue;
    }

    // unordered list
    const ulMatch = line.match(/^\s*[-*+]\s+(.*)$/);
    if(ulMatch){
      flushParagraph();
      if(inOl){ outParts.push("</ol>"); inOl = false; }
      if(!inUl){
        outParts.push("<ul>");
        inUl = true;
      }
      outParts.push(`<li>${inlineFormatting(escapeHtml(ulMatch[1]))}</li>`);
      continue;
    } else if(inUl && line.trim() === ""){
      outParts.push("</ul>");
      inUl = false;
      continue;
    }

    // ordered list
    const olMatch = line.match(/^\s*\d+\.\s+(.*)$/);
    if(olMatch){
      flushParagraph();
      if(inUl){ outParts.push("</ul>"); inUl = false; }
      if(!inOl){
        outParts.push("<ol>");
        inOl = true;
      }
      outParts.push(`<li>${inlineFormatting(escapeHtml(olMatch[1]))}</li>`);
      continue;
    } else if(inOl && line.trim() === ""){
      outParts.push("</ol>");
      inOl = false;
      continue;
    }

    // ç©ºè¡Œ -> æ®µè½åˆ†éš”
    if(line.trim() === ""){
      flushParagraph();
      continue;
    }

    // æ™®é€šæ–‡æœ¬è¡Œï¼šåˆå¹¶åˆ°å½“å‰ paragraph
    const formatted = inlineFormatting(escapeHtml(line.trim()));
    if(paragraph === null){
      paragraph = formatted;
    } else {
      // ä½¿ç”¨ç©ºæ ¼åˆ†éš”åŸå§‹è¡Œï¼Œä¿ç•™æ›´ç´§å‡‘çš„è§†è§‰æ•ˆæœ
      paragraph += " " + formatted;
    }
  }

  flushParagraph();
  if(inUl) outParts.push("</ul>");
  if(inOl) outParts.push("</ol>");

  let html = outParts.join("\n");

  // æ¢å¤ä»£ç å—å ä½ï¼ˆå¹¶å¯¹ä»£ç å†…å®¹åš escapeHtmlï¼‰
  html = html.replace(/@@CODEBLOCK_(\d+)@@/g, (m, idx) => {
    const cb = codeBlocks[Number(idx)];
    if(!cb) return "";
    const escapedCode = escapeHtml(cb.code);
    const langClass = cb.lang ? ` class="language-${escapeHtml(cb.lang)}"` : "";
    // ç»™ code å…ƒç´ åŠ ä¸Š inline class åç§°ï¼ˆhighlight.js å¯è‡ªåŠ¨æ£€æµ‹ï¼‰ï¼Œå¹¶ä¿ç•™ language- å‰ç¼€ç»™è§’æ ‡ä½¿ç”¨
    return `<pre><code${langClass}>${escapedCode}</code></pre>`;
  });

  return html;
}

/**
 * è¡Œå†…æ ¼å¼ï¼ˆä½œç”¨åœ¨å·² escape çš„æ–‡æœ¬ï¼‰
 * æ”¯æŒï¼š
 *  - è¡Œå†…ä»£ç  `code`
 *  - ç²—ä½“ **text**
 *  - æ–œä½“ *text*
 *  - é“¾æ¥ [text](url)
 *
 * æ³¨æ„ï¼šå‡å®šè¾“å…¥å·² escapeHtml è¿‡
 */
function inlineFormatting(escapedText){
  if(!escapedText) return "";

  // è¡Œå†…ä»£ç å…ˆå ä½
  const codePlaceholders = [];
  escapedText = escapedText.replace(/`([^`]+)`/g, (m, code) => {
    const idx = codePlaceholders.length;
    codePlaceholders.push(code);
    return `@@INLINECODE_${idx}@@`;
  });

  // é“¾æ¥ [text](url)
  escapedText = escapedText.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (m, text, url) => {
    const safeText = text; // å·² escapeHtml
    const safeUrl = (/^(https?:\/\/|mailto:)/i.test(url) ? escapeHtml(url) : "#");
    return `<a href="${safeUrl}" target="_blank" rel="noopener noreferrer">${safeText}</a>`;
  });

  // ç²—ä½“ **text**
  escapedText = escapedText.replace(/\*\*(.+?)\*\*/g, (m, t) => `<strong>${t}</strong>`);

  // æ–œä½“ *text* ï¼ˆé¿å…ä¸ ** å†²çªï¼‰
  escapedText = escapedText.replace(/(^|[^*])\*([^*]+)\*([^*]|$)/g, (m, a, t, b) => {
    const left = a;
    const right = b;
    return `${left}<em>${t}</em>${right}`;
  });

  // æ¢å¤è¡Œå†…ä»£ç 
  escapedText = escapedText.replace(/@@INLINECODE_(\d+)@@/g, (m, idx) => {
    const code = codePlaceholders[Number(idx)];
    return `<code class="inline">${code}</code>`;
  });

  return escapedText;
}

/* ------------------ æ¸²æŸ“æ¶ˆæ¯ï¼ˆä½¿ç”¨ Markdown æ¸²æŸ“ï¼‰ ------------------ */
function renderMessages() {
  msgsEl.innerHTML = "";
  for (const m of messages) {
    if(m.role==="system") continue;
    const el = document.createElement("div");
    el.className = "msg " + (m.role === "user" ? "user" : "ai");

    // ä¸º AI æ¶ˆæ¯æ˜¾ç¤º metaï¼ˆæ˜µç§° + æ‰“å­—ç‚¹ï¼‰
    if(m.role === "assistant") {
      const meta = document.createElement("div");
      meta.className = "meta";
      const nickWrap = document.createElement("div");
      nickWrap.className = "nick";

      // æ–‡æœ¬æ˜µç§°
      const nick = document.createElement("span");
      nick.textContent = aiNickEl.value || "AI";

      nickWrap.appendChild(nick);
      meta.appendChild(nickWrap);

      // AI æ­£åœ¨æ‰“å­—çš„çŠ¶æ€
      if(m.content==="_typing"){
        const dots = document.createElement("div");
        dots.className = "typing-dots";
        dots.innerHTML = "<span></span><span></span><span></span>";
        meta.appendChild(dots);
        el.appendChild(meta);
        msgsEl.appendChild(el);
        continue;
      }
      el.appendChild(meta);
    }

    const content = document.createElement("div");

    // === ä¿®æ”¹ç‚¹ï¼šå¦‚æœæ˜¯ç”¨æˆ·ï¼ˆuserï¼‰çš„æ¶ˆæ¯ï¼Œä½œä¸ºçº¯æ–‡æœ¬æ¸²æŸ“ï¼ˆtextContentï¼‰
    if (m.role === "user") {
      content.textContent = m.content;
      el.appendChild(content);
    } else {
      // AI æ¶ˆæ¯ä»ç„¶æ”¯æŒ markdown -> HTMLï¼ˆåŒ…å« code blockï¼‰
      // ä½†æˆ‘ä»¬éœ€è¦æŠŠ reasoningï¼ˆæ€ç»´é“¾ï¼‰å•ç‹¬ä½œä¸ºæŠ˜å é¢æ¿æ¸²æŸ“
      content.innerHTML = markdownToHtml(m.content || "");
      el.appendChild(content);

      // å¦‚æœæœ‰ reasoning å­—æ®µï¼Œåˆ™æ¸²æŸ“æŠ˜å åŒºåŸŸ
      if(m.reasoning){
        // container for toggle + collapsed reasoning
        const toggleWrap = document.createElement("div");
        toggleWrap.className = "reasoning-toggle";

        const label = document.createElement("div");
        label.className = "reason-label";
        label.textContent = "æ·±åº¦æ€è€ƒ Reasoning";

        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = m.reasonCollapsed ? "å±•å¼€æ€ç»´é“¾" : "æ”¶èµ·æ€è€ƒé“¾";
        btn.addEventListener("click", ()=>{
          m.reasonCollapsed = !m.reasonCollapsed;
          // ä¿å­˜åˆ° storage
          saveCurrentSession();
          renderMessages();
        });

        toggleWrap.appendChild(label);
        toggleWrap.appendChild(btn);
        el.appendChild(toggleWrap);

        // reasoning content box
        const rbox = document.createElement("div");
        rbox.className = "reasoning-box";

        if(m.reasonCollapsed){
          // æŠ˜å åï¼šå®Œå…¨éšè—ï¼ˆä¸æ¸²æŸ“é¢„è§ˆã€ä¸æ˜¾ç¤ºæ¸å˜ï¼‰
          rbox.style.display = "none";
        } else {
          // fully expanded: render reasoning content (ç¡®ä¿æ²¡æœ‰é˜´å½±)
          rbox.style.display = "";
          rbox.style.boxShadow = "none";
          rbox.innerHTML = markdownToHtml(m.reasoning || "");
        }
        el.appendChild(rbox);
      }
    }

    msgsEl.appendChild(el);
  }

  // åœ¨æ¶ˆæ¯åˆ—è¡¨æœ«å°¾æ·»åŠ  spacerï¼Œé¿å…å›ºå®šåº•éƒ¨é®æŒ¡æœ€åä¸€æ¡æ¶ˆæ¯
  const spacer = document.createElement("div");
  spacer.className = "messages-spacer";
  msgsEl.appendChild(spacer);

  // æ»šåŠ¨åˆ°åº•éƒ¨
  const container = msgsEl.parentElement;
  container.scrollTop = container.scrollHeight;

  // ä¿å­˜å½“å‰ä¼šè¯
  saveCurrentSession();

  // å¢å¼ºï¼šå¯¹æ‰€æœ‰ code block æ³¨å…¥å¤åˆ¶æŒ‰é’®å¹¶æ‰§è¡Œé«˜äº®
  enhanceCodeBlocks();
}

/* ---------- ä¸º code blocks æ³¨å…¥å¤åˆ¶æŒ‰é’®ä¸è¯­è¨€è§’æ ‡ï¼Œå¹¶æ‰§è¡Œ highlight ---------- */
function enhanceCodeBlocks(){
  // highlight.js å…¨å±€å‡½æ•° hljs å¯ç”¨ï¼ˆé€šè¿‡ CDN å¼•å…¥ï¼‰
  // 1. æ‰¾åˆ°æ‰€æœ‰ <pre><code>
  const pres = msgsEl.querySelectorAll("pre");
  pres.forEach(pre => {
    // é˜²æ­¢é‡å¤æ³¨å…¥
    if(pre.dataset.enhanced === "1") return;
    pre.dataset.enhanced = "1";

    const codeEl = pre.querySelector("code");
    if(!codeEl) return;

    // è¯­è¨€è§’æ ‡ï¼šä» class name æå– language-xxx æˆ–è€…å°è¯• hljs è‡ªåŠ¨æ£€æµ‹
    let langLabel = "";
    const classList = Array.from(codeEl.classList || []);
    const langCls = classList.find(c => /^language-/.test(c) || /^hljs-/.test(c));
    if(langCls){
      langLabel = langCls.replace(/^language-/, "").replace(/^hljs-/, "");
    } else {
      // å°è¯•è‡ªåŠ¨æ£€æµ‹ï¼ˆhljs.getLanguageï¼‰
      try {
        const detected = hljs.highlightAuto(codeEl.textContent || "");
        if(detected && detected.language) langLabel = detected.language;
      } catch(e){}
    }

    // åˆ›å»ºå³ä¸Šè§’å®¹å™¨ï¼ˆè¯­è¨€è§’æ ‡ + å¤åˆ¶æŒ‰é’®ï¼‰
    const controls = document.createElement("div");
    controls.className = "code-controls";

    // language badge
    if(langLabel){
      const lb = document.createElement("div");
      lb.className = "lang-badge";
      lb.textContent = langLabel;
      controls.appendChild(lb);
    }

    // copy button
    const copyBtn = document.createElement("button");
    copyBtn.className = "copy-btn";
    copyBtn.type = "button";
    copyBtn.title = "å¤åˆ¶ä»£ç ";
    copyBtn.textContent = "Copy";
    controls.appendChild(copyBtn);

    pre.appendChild(controls);

    // copy action
    copyBtn.addEventListener("click", async () => {
      const codeText = codeEl.textContent || "";
      try{
        await navigator.clipboard.writeText(codeText);
        const original = copyBtn.textContent;
        copyBtn.textContent = "å·²å¤åˆ¶";
        setTimeout(()=> copyBtn.textContent = original, 1200);
      }catch(e){
        // fallback
        const ta = document.createElement("textarea");
        ta.value = codeText;
        document.body.appendChild(ta);
        ta.select();
        try{
          document.execCommand('copy');
          const original = copyBtn.textContent;
          copyBtn.textContent = "å·²å¤åˆ¶";
          setTimeout(()=> copyBtn.textContent = original, 1200);
        }catch(err){
          alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ä»£ç ");
        } finally {
          document.body.removeChild(ta);
        }
      }
    });

    // è®© highlight.js é«˜äº®ï¼ˆå¦‚æœ library åŠ è½½å®Œä¼šå·¥ä½œï¼‰
    try{
      hljs.highlightElement(codeEl);
    }catch(e){}
  });
}

/* ---------- æ¶ˆæ¯ç®¡ç† ---------- */
function addMessage(role, content, extra = {}) {
  // extra å¯ä»¥åŒ…å« reasoning, reasonCollapsed, id
  const msg = Object.assign({role, content}, extra);
  // ensure id
  if(!msg.id) msg.id = `m_${Date.now()}_${Math.floor(Math.random()*1000)}`;

  // **å…³é”®æ”¹åŠ¨**ï¼šå¦‚æœæ˜¯ assistant ä¸”æœªæ˜¾å¼è®¾ç½® reasonCollapsedï¼Œé»˜è®¤ä½¿ç”¨è®¾ç½®ï¼ˆä»…å½“â€œæ·±åº¦æ€è€ƒâ€æ¨¡å¼è¢«å¯ç”¨æ—¶æ‰åº”ç”¨è¯¥é»˜è®¤æŠ˜å è®¾å®šï¼‰
  if(msg.role === "assistant" && typeof msg.reasonCollapsed === "undefined"){
    // åªæœ‰åœ¨ reasoner æ¨¡å¼å¼€å¯æ—¶ï¼Œæ‰æŠŠé»˜è®¤æŠ˜å è®¾ç½®åº”ç”¨äº assistant æ¶ˆæ¯ï¼ˆé¿å…å½±å“æ™®é€šèŠå¤©æ¨¡å‹ï¼‰
    msg.reasonCollapsed = (isReasoningEnabled() && isDefaultReasonCollapsed()) ? true : false;
  }

  messages.push(msg);
  renderMessages();
}

function getBeijingTime(){
  const now = new Date();
  const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
  const bj = new Date(utc + 8*3600*1000);
  return bj.toLocaleString("zh-CN", {hour12:false});
}

/* ---------- è·å–/å­˜å‚¨ è®¾ç½®ï¼ˆåŒ…å« API Key & reasoning å¼€å…³ï¼‰ ---------- */
function loadSettings(){
  const s = JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}");
  if(s.aiNick) aiNickEl.value = s.aiNick;
  if(s.signature) signatureInputEl.value = s.signature;
  if(s.userPrompt) userPromptEl.value = s.userPrompt;
  if(s.apiKey) apiKeyEl.value = s.apiKey;
  if(typeof s.reasoningEnabled !== "undefined") reasoningToggleEl.checked = !!s.reasoningEnabled;
  // æ–°å¢ï¼šè¯»å–é»˜è®¤æŠ˜å æ€ç»´é“¾å¼€å…³
  if(typeof s.defaultReasonCollapsed !== "undefined") defaultReasonCollapsedToggleEl.checked = !!s.defaultReasonCollapsed;
  aiTitleTextEl.textContent = aiNickEl.value || "AI èŠå¤©";
  headerTitleUpdate();
}

function saveSettings(){
  const settings = {
    aiNick: aiNickEl.value,
    signature: signatureInputEl.value,
    userPrompt: userPromptEl.value,
    apiKey: apiKeyEl.value,
    reasoningEnabled: reasoningToggleEl.checked,
    // æ–°å¢ï¼šä¿å­˜é»˜è®¤æŠ˜å æ€ç»´é“¾å¼€å…³
    defaultReasonCollapsed: defaultReasonCollapsedToggleEl.checked
  };
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  headerTitleUpdate();
}

/* è¯»å–å½“å‰ä¿å­˜çš„ API Keyï¼ˆä¸æ‰“å°ã€ä¸æ³„éœ²ï¼‰ */
function getApiKey(){
  const s = JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}");
  return s.apiKey || "";
}
function isReasoningEnabled(){
  const s = JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}");
  return !!s.reasoningEnabled;
}
// æ–°å¢ï¼šåˆ¤æ–­â€œé»˜è®¤æŠ˜å æ€ç»´é“¾â€æ˜¯å¦å¼€å¯
function isDefaultReasonCollapsed(){
  const s = JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}");
  return !!s.defaultReasonCollapsed;
}

function headerTitleUpdate(){
  aiTitleTextEl.textContent = aiNickEl.value || "AI èŠå¤©";
  // æ˜¾ç¤ºä¸ªç­¾ï¼ŒåŒæ—¶åœ¨ä¸ªç­¾åæ˜¾ç¤ºå½“å‰ä¼šè¯åï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œä¸æ”¹å˜æ ·å¼ç»“æ„
  const sig = signatureInputEl.value || "";
  const sessionName = currentSession ? currentSession.name : "";
  signatureEl.textContent = sessionName ? (sig ? (sig + " Â· " + sessionName) : sessionName) : sig;
}

/* ---------- å‘é€å¹¶æµå¼æ¥æ”¶ï¼ˆä¿æŒåŸé€»è¾‘ï¼Œä½†ä½¿ç”¨æœ¬åœ°å­˜å‚¨çš„ API Keyï¼Œå¹¶æ”¯æŒ reasoningï¼‰ ---------- */
async function sendMessage(){
  const text = inputEl.value.trim();
  if(!text) return;
  inputEl.value = "";
  inputEl.style.height = "44px"; // é‡ç½®é«˜åº¦
  // add user message
  addMessage("user", text);

  const sysPrompt = `ç°åœ¨æ˜¯ ${getBeijingTime()}ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ä½ æ­£åœ¨é€šè¿‡ç½‘é¡µå’Œç”¨æˆ·èŠå¤©\nç”¨æˆ·æç¤ºï¼š${userPromptEl.value||""}`;
  // build messages for API: include system + conversation (only role/content)
  const apiMessages = [{role:"system", content: sysPrompt}];
  for(const m of messages){
    // filter out assistant typing placeholder
    if(m.role==="assistant" && m.content==="_typing") continue;
    if(m.role === "assistant" || m.role === "user"){
      apiMessages.push({role:m.role, content:m.content});
    }
  }

  // æ·»åŠ  AI æ­£åœ¨æ‰“å­—çš„å ä½æ°”æ³¡ï¼ˆåŒ…å« idï¼‰
  const placeholderId = `m_${Date.now()}_${Math.floor(Math.random()*1000)}`;
  // **å…³é”®æ”¹åŠ¨**ï¼šå ä½ç¬¦çš„ reasonCollapsed åº”ä¾æ®è®¾ç½®ï¼ˆä»…åœ¨ deep-reasoner æ¨¡å¼å¯ç”¨æ—¶åº”ç”¨é»˜è®¤æŠ˜å ï¼‰
  const placeholderReasonCollapsed = (isReasoningEnabled() && isDefaultReasonCollapsed()) ? true : false;
  addMessage("assistant","_typing",{id:placeholderId, reasoning: null, reasonCollapsed: placeholderReasonCollapsed});
  let replyMessageIndex = messages.findIndex(mm => mm.id === placeholderId);
  if(replyMessageIndex === -1) replyMessageIndex = messages.length - 1;

  try {
    const apiKey = getApiKey();
    if(!apiKey){
      // å¦‚æœæ²¡æœ‰é…ç½® Keyï¼Œæç¤ºç”¨æˆ·å¹¶æŠŠå ä½æ›¿æ¢ä¸ºé”™è¯¯å†…å®¹
      const reply = {role:"assistant", content: "\n[é”™è¯¯] è¯·åœ¨è®¾ç½®ä¸­å¡«å†™ API Key åé‡è¯•ã€‚", reasoning:null, reasonCollapsed:false, id:placeholderId};
      messages[replyMessageIndex] = reply;
      renderMessages();
      return;
    }

    // æ ¹æ®è®¾ç½®é€‰æ‹©æ¨¡å‹
    const modelToUse = isReasoningEnabled() ? MODEL_REASONER : MODEL_CHAT;
    const url = API_BASE + "/chat/completions"; // note: example shows /chat/completions; original used /v1/chat/completions â€” both might be valid; keep as /chat/completions per provided example
    // Use stream: true to keep previous behavior (but gracefully handle non-stream)
    const useStream = true;
    const bodyObj = {model: modelToUse, messages: apiMessages, stream: useStream};
    const res = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        "Authorization":"Bearer "+apiKey
      },
      body: JSON.stringify(bodyObj)
    });

    if(!res.ok){
      // Try to parse error body for details
      let errText = `API é”™è¯¯ ${res.status}`;
      try{ const errJson = await res.json(); if(errJson.error && errJson.error.message) errText += ": "+errJson.error.message;}catch(e){}
      throw new Error(errText);
    }

    if(useStream && res.body){
      // æµå¼å¤„ç†ï¼ˆä¿ç•™åŸæ¥çš„æµå¼åˆå¹¶é€»è¾‘ï¼‰ï¼Œå¹¶å°è¯•æ•è· reasoning_content å­—æ®µ
      const reader = res.body.getReader();
      const decoder = new TextDecoder("utf-8");
      let buffer = "";
      // ensure the placeholder is an object we can update
      if(messages[replyMessageIndex].content==="_typing"){
        // æ ‡è®° streaming: trueï¼Œè¡¨ç¤ºæ­£åœ¨æµå¼è¾“å‡º
        messages[replyMessageIndex] = {role:"assistant", content:"", reasoning:null, reasonCollapsed: placeholderReasonCollapsed, id:placeholderId, streaming: true};
      } else {
        // å¦‚æœä¸æ˜¯ _typingï¼ˆè¾¹ç•Œæƒ…å†µï¼‰ï¼Œä¹Ÿç¡®ä¿ streaming æ ‡è®°
        messages[replyMessageIndex].streaming = true;
      }
      // initial render so UI shows message (å¹¶è§¦å‘ä¸€æ¬¡ä¿å­˜ï¼Œä½† saveCurrentSession ä¼šæ£€æµ‹ streaming å¹¶è·³è¿‡æ€»ç»“)
      renderMessages();

      let reply = messages[replyMessageIndex];
      while(true){
        const {done, value} = await reader.read();
        if(done) break;
        buffer += decoder.decode(value, {stream:true});
        const parts = buffer.split("\n\n");
        buffer = parts.pop();
        for(const part of parts){
          if(!part.startsWith("data:")) continue;
          const data = part.slice(5).trim();
          if(!data) continue;
          if(data==="[DONE]") continue;
          try{
            const obj = JSON.parse(data);
            // streaming delta may contain delta.content or delta.reasoning_content
            const delta = obj.choices?.[0]?.delta || {};
            if(delta.content){
              reply.content += delta.content;
              messages[replyMessageIndex] = reply;
              renderMessages();
            }
            if(delta.reasoning_content){
              // accumulate reasoning chunks in reply.reasoning
              reply.reasoning = (reply.reasoning || "") + delta.reasoning_content;
              messages[replyMessageIndex] = reply;
              renderMessages();
            }
            // Some servers stream top-level message pieces differently; if final chunk contains 'message' with both fields:
            const finishMessage = obj.choices?.[0]?.message;
            if(finishMessage){
              if(finishMessage.content) reply.content += finishMessage.content;
              if(finishMessage.reasoning_content) reply.reasoning = (reply.reasoning || "") + finishMessage.reasoning_content;
              messages[replyMessageIndex] = reply;
              renderMessages();
            }
          }catch(e){
            // ignore malformed chunk
          }
        }
      }
      // æµç»“æŸåç¡®ä¿æŠŠæœ€ç»ˆæ•°æ®å†™å›å¹¶ä¿å­˜
      // æ ‡è®° streaming å®Œæˆ -> è§¦å‘ä¸€æ¬¡æœ€ç»ˆä¿å­˜ï¼ˆæ­¤æ—¶ saveCurrentSession ä¼šå…è®¸æ€»ç»“ï¼‰
      reply.streaming = false;
      messages[replyMessageIndex] = reply;
      saveCurrentSession();
      renderMessages();
    } else {
      // éæµå¼ï¼šç›´æ¥ parse JSON
      const j = await res.json();
      // try to extract assistant message
      const choice = j.choices && j.choices[0];
      let assistantText = "";
      let reasoningText = null;
      if(choice){
        // some APIs use choice.message.content
        if(choice.message && typeof choice.message.content === "string"){
          assistantText = choice.message.content;
        } else if(choice.text){ // fallback
          assistantText = choice.text;
        }
        // reasoning content may be in message.reasoning_content or in other fields
        if(choice.message && typeof choice.message.reasoning_content === "string"){
          reasoningText = choice.message.reasoning_content;
        } else if(choice.reasoning_content){
          reasoningText = choice.reasoning_content;
        }
      }
      // Replace placeholder with final reply
      // **å…³é”®æ”¹åŠ¨**ï¼šå¦‚æœå­˜åœ¨ reasoningTextï¼Œåˆ™æ ¹æ®â€œé»˜è®¤æŠ˜å æ€ç»´é“¾â€è®¾ç½®å†³å®š reasonCollapsed
      const reply = {role:"assistant", content: assistantText || "[ç©ºå›å¤]", reasoning: reasoningText, reasonCollapsed: (reasoningText ? isDefaultReasonCollapsed() : false), id:placeholderId, streaming: false};
      messages[replyMessageIndex] = reply;
      saveCurrentSession();
      renderMessages();
    }
  }catch(e){
    // error handling: replace typing placeholder with error message
    const errMsg = {role:"assistant", content: "\n[é”™è¯¯] " + e.message, reasoning:null, reasonCollapsed:false, id:placeholderId, streaming: false};
    messages[replyMessageIndex] = errMsg;
    saveCurrentSession();
    renderMessages();
  }
}

/* ---------- å¼¹çª—é€»è¾‘ ---------- */
openSettingsBtn.addEventListener("click", ()=>{
  loadSettings();
  settingsModal.style.display="flex";
});
closeSettingsBtn.addEventListener("click", ()=>{settingsModal.style.display="none";});
saveSettingsBtn.addEventListener("click", ()=>{
  saveSettings();
  settingsModal.style.display="none";
  renderMessages();
});

/* ---------- Sessions å¼¹çª—é€»è¾‘ ---------- */
openSessionsBtn.addEventListener("click", ()=>{
  loadSettings(); // also ensure header updated
  renderSessionsList();
  sessionsModal.style.display = "flex";
});
closeSessionsBtn.addEventListener("click", ()=>{ sessionsModal.style.display = "none"; });

/* ---------- åŸâ€œæ¸…ç©ºå†å²â€æŒ‰é’®ç°åœ¨å˜ä¸ºâ€œæ–°å»ºä¼šè¯â€æŒ‰é’® ----------
   å…³é”®ä¿®æ”¹ï¼šåˆ›å»ºæ–°ä¼šè¯ä½†ä¸è‡ªåŠ¨æ‰“å¼€ä¼šè¯ç®¡ç†å¼¹çª—
*/
clearHistoryBtn.addEventListener("click", ()=>{
  // åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºä¼šè¯å¹¶åˆ‡æ¢åˆ°å®ƒ
  createSession("");
  // ä¹‹å‰è¿™é‡Œä¼šè‡ªåŠ¨æ‰“å¼€ sessionsModalï¼›ç°åœ¨ç§»é™¤è¯¥è¡Œä¸ºï¼Œä¿æŒç•Œé¢ä¸å¼¹å‡º
  // renderSessionsList();
  // sessionsModal.style.display = "flex";
});

/* ---------- å‘é€äº‹ä»¶ & è¾“å…¥é«˜åº¦ & collapsed è¡Œä¸º ---------- */
sendBtn.addEventListener("click", sendMessage);

/* === å…³é”®ä¿®æ”¹ï¼šå›è½¦è¡Œä¸ºè°ƒæ•´ ===
   - åŸå…ˆï¼šæŒ‰ Enter ç›´æ¥å‘é€ï¼ˆShift+Enter æ¢è¡Œï¼‰
   - ç°åœ¨ï¼šæŒ‰ Enter æ’å…¥æ¢è¡Œï¼ˆä¸å¸¸è§ç¼–è¾‘å™¨ä¸€è‡´ï¼‰
            å‘é€æ”¹ä¸º Ctrl+Enter æˆ– Cmd+Enterï¼ˆå…¼å®¹ Macï¼‰
*/
inputEl.addEventListener("keydown", (e)=>{
  if((e.key === "Enter") && (e.ctrlKey || e.metaKey)){
    e.preventDefault();
    sendMessage();
    // keep expanded after sending
    setExpandedState(false);
  }
});
inputEl.addEventListener('input', ()=>{
  // if user types, ensure expanded
  setExpandedState(true);
  inputEl.style.height = "auto";
  inputEl.style.height = Math.min(inputEl.scrollHeight,240)+"px";
});

/* ---------- è§†è§‰è§†å£ï¼ˆVisualViewportï¼‰ç”¨äºå¤„ç†é”®ç›˜é«˜åº¦ï¼Œé¿å…é—´éš™ ---------- */
const BASE_BOTTOM_HEIGHT = 76; // ä¸ css :root --bottom-height åŸºç¡€ä¿æŒä¸€è‡´
function updateForViewport(){
  const vv = window.visualViewport;
  let kb = 0;
  if(vv){
    // è®¡ç®—é”®ç›˜é«˜åº¦ï¼šçª—å£å†…é«˜åº¦ï¼ˆinnerHeightï¼‰å‡å» visualViewport.heightï¼ˆå—é”®ç›˜å½±å“ï¼‰
    kb = Math.max(0, window.innerHeight - vv.height - (vv.offsetTop || 0));
  } else {
    // fallback: ä½¿ç”¨ window.innerHeight ä¸ document.documentElement.clientHeight ä¹‹å·®ï¼ˆæŸäº›æµè§ˆå™¨ï¼‰
    kb = Math.max(0, window.innerHeight - document.documentElement.clientHeight);
  }
  // è®¾ç½® bottom å…ƒç´ åº•éƒ¨é—´è·ï¼ˆå›ºå®šå®šä½ï¼‰ï¼Œå¹¶æ›´æ–° main çš„ padding-bottomï¼ˆé€šè¿‡ css å˜é‡ï¼‰
  bottomEl.style.bottom = (kb > 0 ? kb + 'px' : '0px');
  document.documentElement.style.setProperty('--bottom-height', `${BASE_BOTTOM_HEIGHT + kb}px`);
  // å½“è¾“å…¥æ¡†è·å–ç„¦ç‚¹æ—¶ç¡®ä¿æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆç»™ç§»åŠ¨ç«¯æ—¶é—´ï¼‰
  setTimeout(()=>{ const container = msgsEl.parentElement; container.scrollTop = container.scrollHeight; }, 120);
}

/* ç›‘å¬ visualViewport å˜åŒ–ï¼ˆå¤šæ•°ç§»åŠ¨ç«¯æµè§ˆå™¨æ”¯æŒï¼‰ï¼ŒåŠ resize */
if(window.visualViewport){
  window.visualViewport.addEventListener('resize', updateForViewport, {passive:true});
  window.visualViewport.addEventListener('scroll', updateForViewport, {passive:true});
}
window.addEventListener('resize', updateForViewport);
inputEl.addEventListener('focus', ()=>{
  // expand input on focus
  setExpandedState(true);
  setTimeout(()=>{ updateForViewport(); const container = msgsEl.parentElement; container.scrollTop = container.scrollHeight; }, 250);
});
inputEl.addEventListener('blur', ()=>{ 
  // if empty, collapse after small delay to allow click on send
  setTimeout(()=>{ if(!inputEl.value.trim()) setExpandedState(false); updateForViewport(); }, 160); 
});

/* ---------- æ§åˆ¶è¾“å…¥æ¡† collapsed/expanded ---------- */
function setExpandedState(expand){
  if(expand){
    inputEl.classList.remove("collapsed");
    inputEl.classList.add("expanded");
    // let flex behavior take over
    inputEl.style.width = "";
  } else {
    // collapsed: only when no user content
    if(inputEl.value && inputEl.value.trim()) return;
    inputEl.classList.remove("expanded");
    inputEl.classList.add("collapsed");
    inputEl.style.height = "44px";
    inputEl.style.width = ""; // the .collapsed css sets width
  }
}

/* ---------- ä¼šè¯æ ‡é¢˜è‡ªåŠ¨æ€»ç»“ï¼ˆé€šè¿‡ APIï¼‰ ----------
   è¯´æ˜ï¼š
   - ä½¿ç”¨ç”¨æˆ·åœ¨è®¾ç½®ä¸­é…ç½®çš„ API Keyï¼ˆgetApiKey()ï¼‰è°ƒç”¨æ¨¡å‹ç”ŸæˆçŸ­æ ‡é¢˜
   - æç¤ºæ¨¡å‹åªè¿”å›â€œæ ‡é¢˜æ–‡æœ¬â€ï¼Œä¸è¿”å›å¤šä½™è¯´æ˜
   - åªåŸºäºå‰å‡ æ¡æ¶ˆæ¯ï¼ˆæœ€å¤§ Nï¼‰ç”Ÿæˆ
   - å¤±è´¥æ—¶é™é»˜ï¼ˆä¸ä¼šé˜»å¡ä¸»æµç¨‹ï¼‰
   - å…³é”®ä¿®æ”¹ï¼šå¦‚æœä¼šè¯è¢«æ ‡è®°ä¸º titleFinalized æˆ–è€…å·²è¶…è¿‡å‰ä¸‰æ¡â€œæœ‰æ„ä¹‰â€æ¶ˆæ¯ï¼Œåˆ™ä¸å†è°ƒç”¨ AIï¼Œæ€»ç»“åœæ­¢
   - å…³é”®ä¿®æ”¹2ï¼šå½“å­˜åœ¨æ­£åœ¨æµå¼è¾“å‡ºçš„ assistant æ¶ˆæ¯æ—¶ï¼Œè·³è¿‡æ€»ç»“ï¼ˆç­‰å¾…æµç»“æŸåç”±æœ€ç»ˆ saveCurrentSession è§¦å‘ï¼‰
*/
async function summarizeSessionTitle(sessionId){
  try{
    const apiKey = getApiKey();
    if(!apiKey) return; // æ²¡é…ç½®å°±ä¸åš
    const all = loadAllSessions();
    if(!all[sessionId]) return;
    const session = all[sessionId];

    // å¦‚æœä¼šè¯å·²ç»è¢«æ ‡è®°ä¸º finalizedï¼Œåˆ™ç›´æ¥è¿”å›ï¼ˆä¸å†è°ƒç”¨ APIï¼‰
    if(session.titleFinalized) return;

    const msgs = Array.isArray(session.messages) ? session.messages : [];
    if(msgs.length === 0) return;

    // è®¡ç®—â€œæœ‰æ„ä¹‰â€æ¶ˆæ¯æ•°é‡ï¼šrole ä¸º user/assistant å¹¶ä¸”ä¸æ˜¯å ä½ _typingï¼Œä¸”æœ‰å®é™…å†…å®¹
    const relevant = [];
    for(let i=0;i<msgs.length;i++){
      const m = msgs[i];
      if((m.role === "user" || m.role === "assistant") && m.content !== "_typing" && String(m.content||"").trim()){
        relevant.push(m);
      }
      if(relevant.length >= 4) break; // æˆ‘ä»¬åªå…³å¿ƒæ˜¯å¦è¶…è¿‡ 3 æ¡
    }
    // å¦‚æœå·²ç»è¶…è¿‡ 3 æ¡ï¼Œåˆ™æŠŠä¼šè¯æ ‡è®°ä¸º finalized å¹¶é€€å‡ºï¼ˆèŠ‚çœè°ƒç”¨ï¼‰
    if(relevant.length > 3){
      session.titleFinalized = true;
      session.updatedAt = Date.now();
      all[session.id] = session;
      saveAllSessions(all);
      return;
    }

    // å–å‰å‡ æ¡æœ‰æ„ä¹‰çš„æ¶ˆæ¯ï¼ˆuser/assistantï¼‰ï¼Œæœ€å¤š 3 æ¡
    const selected = relevant.slice(0,3).map(m=>({role:m.role, content: String(m.content || "").trim()}));
    if(selected.length === 0) return;

    // æ„å»º promptï¼šè®©æ¨¡å‹è¿”å›ç®€çŸ­çš„æ ‡é¢˜ï¼ˆæœ€å¤š 40 å­—ï¼‰ï¼Œä»…è¿”å›æ ‡é¢˜æœ¬èº«ï¼Œä¸è¦è§£é‡Š
    const promptMessages = [];
    promptMessages.push({
      role: "system",
      content: "ä½ æ˜¯ä¸€ä¸ªåŠ©æ‰‹ï¼Œæ“…é•¿ä¸ºå¯¹è¯ç”Ÿæˆç®€çŸ­ã€å‡†ç¡®çš„ä¼šè¯æ ‡é¢˜ã€‚è¯·åªè¿”å›æ ‡é¢˜æ–‡æœ¬ï¼Œä¸è¦åŒ…å«å¼•å·æˆ–é¢å¤–è¯´æ˜ã€‚é•¿åº¦å»ºè®®ä¸è¶…è¿‡ 40 ä¸ªå­—ç¬¦ã€‚"
    });
    // å°†æ‰€é€‰æ¶ˆæ¯ä»¥ç®€å•æ ¼å¼æ”¾å…¥ user ä¿¡æ¯ä¸­
    let userContent = "ä»¥ä¸‹æ˜¯ä¼šè¯çš„å‰å‡ æ¡æ¶ˆæ¯ï¼Œè¯·åŸºäºè¿™äº›å†…å®¹ç»™å‡ºä¸€ä¸ªç®€æ´çš„ä¼šè¯æ ‡é¢˜ï¼š\n\n";
    for(const r of selected){
      userContent += `${r.role === 'user' ? 'ç”¨æˆ·' : 'åŠ©æ‰‹'}: ${r.content}\n`;
    }
    userContent += "\nåªè¾“å‡ºæ ‡é¢˜æœ¬èº«ã€‚";
    promptMessages.push({role:"user", content: userContent});

    const url = API_BASE + "/chat/completions";
    const body = {
      model: MODEL_CHAT,
      messages: promptMessages,
      stream: false,
      max_tokens: 32,
      temperature: 0.3
    };

    const res = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        "Authorization":"Bearer "+apiKey
      },
      body: JSON.stringify(body)
    });

    if(!res.ok) return;
    const j = await res.json();
    const choice = j.choices && j.choices[0];
    let title = "";
    if(choice){
      if(choice.message && typeof choice.message.content === "string"){
        title = choice.message.content;
      } else if(choice.text){
        title = choice.text;
      }
    }
    if(!title) return;
    title = String(title).trim();
    // ä¸€äº›æ¨¡å‹å¯èƒ½è¿”å›å¤šè¡Œæˆ–è§£é‡Šï¼Œå–é¦–è¡Œ
    title = title.split("\n")[0].trim();
    // å»é™¤å·¦å³å¼•å·
    title = title.replace(/^["'`]+|["'`]+$/g, "");
    if(title.length === 0) return;
    // é™åˆ¶é•¿åº¦
    if(title.length > 60) title = title.slice(0,60) + "...";

    // æ›´æ–°å­˜å‚¨ä¸­çš„ä¼šè¯åï¼ˆä»…å½“ä¸ç°æœ‰ä¸åŒï¼‰
    if(session.name !== title){
      session.name = title;
      session.updatedAt = Date.now();
      all[session.id] = session;
      saveAllSessions(all);
      // å¦‚æœæ›´æ–°çš„æ˜¯å½“å‰ä¼šè¯ï¼Œæ›´æ–° currentSession å¼•ç”¨å¹¶åˆ·æ–° header
      if(currentSession && currentSession.id === session.id){
        currentSession.name = title;
        headerTitleUpdate();
      }
      renderSessionsList();
    }
  }catch(e){
    // å¿½ç•¥é”™è¯¯ï¼ˆéé˜»å¡ï¼‰
    // console.warn("summarizeSessionTitle failed", e);
  }
}

/* ---------- fallback ä¿è¯åœ¨ load æ—¶æ­£ç¡®è®¾ç½® ---------- */
window.addEventListener("load", ()=>{
  // 1. è¿ç§»æ—§æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰
  migrateLegacyStorageIfNeeded();
  // 2. åŠ è½½å½“å‰ä¼šè¯
  loadSettings();
  loadCurrentSession();
  headerTitleUpdate();
  // initialize collapsed state (start collapsed if input empty)
  if(!inputEl.value || !inputEl.value.trim()){
    inputEl.classList.add("collapsed");
  } else {
    inputEl.classList.add("expanded");
  }
  renderSessionsList();
  renderMessages();
  updateForViewport();
});

/* å…¼å®¹ï¼šåœ¨è½¯é”®ç›˜å¼¹èµ·ååšä¸€æ¬¡æœ€ç»ˆæ»šåŠ¨ */
window.addEventListener('orientationchange', ()=> setTimeout(updateForViewport, 300));
</script>
</body>
</html>