<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>DeepSeek Chat by é£æ‰‡</title>
<style>
  :root{
    --bg:#0F1113;
    --panel:#191B1E;
    --muted:#8b949e;
    --bubble:#242628;
    --accent:#0066CC;
    --radius:14px;
    --safe-bottom: env(safe-area-inset-bottom, 12px);
    --bottom-height: 76px; /* åŸºç¡€åº•éƒ¨ç©ºé—´, ä¼šåœ¨ runtime åŠ¨æ€è°ƒæ•´ */
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#e6eef6;font-family: Inter, "Helvetica Neue", Arial, sans-serif;-webkit-font-smoothing:antialiased}
  .app{display:flex;flex-direction:column;min-height:100vh;gap:0}
  header{padding:14px 12px;background:var(--panel);border-bottom:1px solid rgba(255,255,255,0.05);display:flex;justify-content:space-between;align-items:center}
  .ai-box{display:flex;flex-direction:column}
  .ai-title{
    font-weight:600;font-size:16px;letter-spacing:0.2px;display:flex;align-items:center;
  }
  .signature{font-size:12px;color:var(--muted);margin-top:4px}
  main{flex:1;overflow:auto;padding:16px;padding-bottom:calc(var(--bottom-height) + var(--safe-bottom));display:flex;flex-direction:column;gap:12px}
  .messages{display:flex;flex-direction:column;gap:12px;align-items:stretch}
  .msg{max-width:78%;padding:10px 12px;border-radius:12px;font-size:15px;line-height:1.45;word-break:break-word;white-space:pre-wrap;background:var(--bubble)}
  .msg.user{margin-left:auto;text-align:left}
  .msg.ai{margin-right:auto;text-align:left}
  .meta{font-size:12px;color:var(--muted);margin-bottom:6px;display:flex;flex-direction:column;align-items:flex-start;gap:4px}
  .nick{font-weight:700;color:#fff;display:flex;align-items:center}
  /* æ‰“å­—åŠ¨ç”»å°ç‚¹ç‚¹ï¼šæ”¾åœ¨æ˜µç§°ä¸‹é¢ */
  .typing-dots{display:inline-flex;gap:6px;margin-top:2px}
  .typing-dots span{width:6px;height:6px;background:var(--muted);border-radius:50%;display:inline-block;animation:blink 1.4s infinite}
  .typing-dots span:nth-child(2){animation-delay:0.2s}
  .typing-dots span:nth-child(3){animation-delay:0.4s}
  @keyframes blink{0%,80%,100%{opacity:.3}40%{opacity:1}}
  /* spacerï¼šç¡®ä¿æœ€åæ¶ˆæ¯ä¸ä¼šè¢«å›ºå®šåº•éƒ¨è¦†ç›– */
  .messages-spacer{height:var(--bottom-height);flex-shrink:0}
  /* å›ºå®šåº•éƒ¨ï¼ŒåŠ¨æ€è°ƒæ•´ bottom å€¼ç”±è„šæœ¬æ§åˆ¶ä»¥é€‚é…é”®ç›˜ */
  .bottom{position:fixed;left:0;right:0;padding:12px 12px calc(12px + var(--safe-bottom));backdrop-filter: blur(6px);background:var(--panel);border-top:1px solid rgba(255,255,255,0.05);z-index:8;transition:bottom 160ms ease}
  .composer{display:flex;gap:8px;align-items:center}
  textarea#input{flex:1;min-height:44px;max-height:240px;border-radius:12px;border:1px solid rgba(255,255,255,0.08);background:#1a1c1e;padding:12px 14px;color:#e6eef6;resize:none;font-size:15px;overflow-y:auto;line-height:1.4}
  .send-btn{background:var(--accent);color:white;padding:10px 12px;border-radius:12px;border:none;font-weight:600;cursor:pointer}
  .settings-btn,.clear-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px;margin-left:8px}
  /* å¼¹çª— */
  .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;z-index:10}
  .modal-content{background:var(--panel);padding:18px;border-radius:var(--radius);width:92%;max-width:520px;box-shadow:0 0 10px rgba(0,0,0,0.4);display:flex;flex-direction:column;gap:6px}
  .modal-content h2{margin:0 0 8px 0;font-size:18px}
  /* label + input å¯¹é½ï¼Œæ‰€æœ‰è¾“å…¥å‡å æ»¡å®½åº¦ */
  .modal-row{display:flex;flex-direction:column;gap:6px;}
  .modal-content label{color:var(--muted);font-size:13px}
  .modal-content input[type="text"], .modal-content input[type="search"], .modal-content input[type="password"]{
    width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:#0F1113;color:#e6eef6;outline:none;box-sizing:border-box;
  }
  /* è‡ªå®šä¹‰æç¤ºè¯æ”¹ä¸º textareaï¼Œç”¨äºå¤§æ®µæ–‡å­—ï¼Œä½†ä¿æŒä¸å…¶å®ƒè¾“å…¥å¯¹é½ */
  .modal-content textarea{width:100%;min-height:120px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:#0F1113;color:#e6eef6;outline:none;box-sizing:border-box;resize:vertical}
  .modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:8px}
  .btn{padding:8px 12px;border:none;border-radius:8px;cursor:pointer;font-weight:600}
  .btn.save{background:var(--accent);color:#fff}
  .btn.close{background:#333;color:#ccc}
  /* å¾®è°ƒæ¶ˆæ¯å®¹å™¨æ»šåŠ¨å¹³æ»‘ */
  main, .messages {scroll-behavior: smooth;}
  @media (max-height:600px){
    .modal-content{max-height:80vh;overflow:auto}
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="ai-box">
      <div class="ai-title" id="headerTitle">
        <div id="aiTitleText">å’ŒdeepseekèŠå¤©ï¼</div>
      </div>
      <div class="signature" id="signature"></div>
    </div>
    <div>
      <button class="clear-btn" id="clearHistory" title="æ¸…é™¤å†å²">ğŸ—‘ï¸</button>
      <button class="settings-btn" id="openSettings" title="è®¾ç½®">âš™ï¸</button>
    </div>
  </header>
  <main>
    <div class="messages" id="messages"></div>
  </main>
  <div class="bottom" id="bottom">
    <div class="composer">
      <textarea id="input" placeholder="Enter your text." rows="1" aria-label="æ¶ˆæ¯è¾“å…¥"></textarea>
      <button id="send" class="send-btn">å‘é€</button>
    </div>
  </div>
</div>

    <!-- è®¾ç½®å¼¹çª—ï¼ˆä¿ç•™ AI æ˜µç§°ã€ä¸ªæ€§ç­¾åä¸è‡ªå®šä¹‰æç¤ºè¯ï¼Œå¹¶æ–°å¢ API Keyï¼‰ -->
<div class="modal" id="settingsModal">
  <div class="modal-content">
    <h2>è®¾ç½®</h2>
    <div class="modal-row">
      <label for="aiNick">æ˜µç§° Name</label>
      <input id="aiNick" type="text" value="å°é£" />
    </div>

    <div class="modal-row">
      <label for="signatureInput">ä¸ªç­¾ Introduction</label>
      <input id="signatureInput" type="text" placeholder="ä¾‹å¦‚ï¼šFly to the sky" />
    </div>

    <div class="modal-row">
      <label for="userPrompt">æ€§æ ¼ Character</label>
      <textarea id="userPrompt" placeholder="å®šä¹‰AIçš„æ€§æ ¼ã€è¯´è¯æ–¹å¼ï¼ˆåœ¨è¿™é‡Œé‡å¤AIçš„åå­—"></textarea>
    </div>

    <div class="modal-row">
      <label for="apiKeyInput">API Keyï¼ˆæœ¬åœ°ä¿å­˜ï¼‰</label>
      <input id="apiKeyInput" type="password" placeholder="sk-xxxxxxxxx" />
    </div>

    <div class="modal-actions">
      <button class="btn close" id="closeSettings">å–æ¶ˆ</button>
      <button class="btn save" id="saveSettings">ä¿å­˜</button>
    </div>
  </div>
</div>

<script>
const API_BASE = "https://api.deepseek.com";
const MODEL = "deepseek-chat";
const STORAGE_KEY = "deepseek_chat_autosave";
const SETTINGS_KEY = "deepseek_chat_settings";

const msgsEl = document.getElementById("messages");
const inputEl = document.getElementById("input");
const sendBtn = document.getElementById("send");
const aiNickEl = document.getElementById("aiNick");
const aiTitleTextEl = document.getElementById("aiTitleText");
const signatureEl = document.getElementById("signature");
const signatureInputEl = document.getElementById("signatureInput");
const userPromptEl = document.getElementById("userPrompt");
const apiKeyEl = document.getElementById("apiKeyInput");

const settingsModal = document.getElementById("settingsModal");
const openSettingsBtn = document.getElementById("openSettings");
const closeSettingsBtn = document.getElementById("closeSettings");
const saveSettingsBtn = document.getElementById("saveSettings");
const clearHistoryBtn = document.getElementById("clearHistory");
const bottomEl = document.getElementById("bottom");
const headerTitle = document.getElementById("headerTitle");

let messages = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");

/* ---------- æ¸²æŸ“æ¶ˆæ¯ï¼ˆæ˜µç§°ç›´æ¥æ˜¾ç¤ºï¼Œä¸å†æ˜¾ç¤ºå°ç«–æ¡ï¼‰ ---------- */
function renderMessages() {
  msgsEl.innerHTML = "";
  for (const m of messages) {
    if(m.role==="system") continue;
    const el = document.createElement("div");
    el.className = "msg " + (m.role === "user" ? "user" : "ai");

    // ä»…å¯¹ AI æ¶ˆæ¯æ˜¾ç¤º metaï¼ˆæ˜µç§° + æ‰“å­—ç‚¹ï¼‰
    if(m.role === "assistant") {
      const meta = document.createElement("div");
      meta.className = "meta";
      const nickWrap = document.createElement("div");
      nickWrap.className = "nick";

      // æ–‡æœ¬æ˜µç§°
      const nick = document.createElement("span");
      nick.textContent = aiNickEl.value || "AI";

      nickWrap.appendChild(nick);
      meta.appendChild(nickWrap);

      // AI æ­£åœ¨æ‰“å­—çš„çŠ¶æ€
      if(m.content==="_typing"){
        const dots = document.createElement("div");
        dots.className = "typing-dots";
        dots.innerHTML = "<span></span><span></span><span></span>";
        meta.appendChild(dots);
        el.appendChild(meta);
        msgsEl.appendChild(el);
        continue;
      }
      el.appendChild(meta);
    }

    const content = document.createElement("div");
    content.textContent = m.content;
    el.appendChild(content);
    msgsEl.appendChild(el);
  }

  // åœ¨æ¶ˆæ¯åˆ—è¡¨æœ«å°¾æ·»åŠ  spacerï¼Œé¿å…å›ºå®šåº•éƒ¨é®æŒ¡æœ€åä¸€æ¡æ¶ˆæ¯
  const spacer = document.createElement("div");
  spacer.className = "messages-spacer";
  msgsEl.appendChild(spacer);

  // æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆæ»šåŠ¨å®¹å™¨ä»ä¸º main çš„çˆ¶å…ƒç´ ï¼‰
  const container = msgsEl.parentElement;
  container.scrollTop = container.scrollHeight;
  localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
}

/* ---------- æ¶ˆæ¯ç®¡ç† ---------- */
function addMessage(role, content){
  messages.push({role, content});
  renderMessages();
}

function getBeijingTime(){
  const now = new Date();
  const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
  const bj = new Date(utc + 8*3600*1000);
  return bj.toLocaleString("zh-CN", {hour12:false});
}

/* ---------- è·å–/å­˜å‚¨ è®¾ç½®ï¼ˆåŒ…å« API Keyï¼‰ ---------- */
function loadSettings(){
  const s = JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}");
  if(s.aiNick) aiNickEl.value = s.aiNick;
  if(s.signature) signatureInputEl.value = s.signature;
  if(s.userPrompt) userPromptEl.value = s.userPrompt;
  if(s.apiKey) apiKeyEl.value = s.apiKey;
  aiTitleTextEl.textContent = aiNickEl.value || "AI èŠå¤©";
  signatureEl.textContent = signatureInputEl.value || "";
}

function saveSettings(){
  const settings = {
    aiNick: aiNickEl.value,
    signature: signatureInputEl.value,
    userPrompt: userPromptEl.value,
    apiKey: apiKeyEl.value
  };
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  headerTitleUpdate();
}

/* è¯»å–å½“å‰ä¿å­˜çš„ API Keyï¼ˆä¸æ‰“å°ã€ä¸æ³„éœ²ï¼‰ */
function getApiKey(){
  const s = JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}");
  return s.apiKey || "";
}

/* æ›´æ–° header æ–‡æœ¬ */
function headerTitleUpdate(){
  aiTitleTextEl.textContent = aiNickEl.value || "AI èŠå¤©";
  signatureEl.textContent = signatureInputEl.value || "";
}

/* ---------- å‘é€å¹¶æµå¼æ¥æ”¶ï¼ˆä¿æŒåŸé€»è¾‘ï¼Œä½†ä½¿ç”¨æœ¬åœ°å­˜å‚¨çš„ API Keyï¼‰ ---------- */
async function sendMessage(){
  const text = inputEl.value.trim();
  if(!text) return;
  inputEl.value = "";
  inputEl.style.height = "44px"; // é‡ç½®é«˜åº¦
  addMessage("user", text);

  const sysPrompt = `ç°åœ¨æ˜¯ ${getBeijingTime()}ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ä½ æ­£åœ¨é€šè¿‡ç½‘é¡µå’Œç”¨æˆ·èŠå¤©\nç”¨æˆ·æç¤ºï¼š${userPromptEl.value||""}`;
  const apiMessages = [{role:"system", content: sysPrompt}, ...messages];

  // æ·»åŠ  AI æ­£åœ¨æ‰“å­—çš„å ä½æ°”æ³¡
  addMessage("assistant","_typing");
  let reply = {role:"assistant", content:""};
  let replyIndex = messages.length-1; // typing çš„ä½ç½®

  try {
    const apiKey = getApiKey();
    if(!apiKey){
      // å¦‚æœæ²¡æœ‰é…ç½® Keyï¼Œæç¤ºç”¨æˆ·å¹¶æŠŠå ä½æ›¿æ¢ä¸ºé”™è¯¯å†…å®¹
      if(messages[replyIndex].content==="_typing"){
        messages[replyIndex] = reply;
      }
      reply.content += "\n[é”™è¯¯] è¯·åœ¨è®¾ç½®ä¸­å¡«å†™ API Key åé‡è¯•ã€‚";
      renderMessages();
      return;
    }

    const url = API_BASE + "/v1/chat/completions";
    const res = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        "Authorization":"Bearer "+apiKey
      },
      body: JSON.stringify({model: MODEL, messages: apiMessages, stream: true})
    });
    if(!res.ok) throw new Error("API é”™è¯¯ " + res.status);
    const reader = res.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let buffer = "";
    while(true){
      const {done, value} = await reader.read();
      if(done) break;
      buffer += decoder.decode(value, {stream:true});
      const parts = buffer.split("\n\n");
      buffer = parts.pop();
      for(const part of parts){
        if(!part.startsWith("data:")) continue;
        const data = part.slice(5).trim();
        if(data==="[DONE]") continue;
        try{
          const obj = JSON.parse(data);
          const delta = obj.choices?.[0]?.delta?.content;
          if(delta){
            if(messages[replyIndex].content==="_typing"){
              messages[replyIndex] = reply; // æ›¿æ¢æ‰ typing å ä½
            }
            reply.content += delta;
            renderMessages();
          }
        }catch(e){}
      }
    }
  }catch(e){
    if(messages[replyIndex].content==="_typing"){
      messages[replyIndex] = reply;
    }
    reply.content += "\n[é”™è¯¯] " + e.message;
    renderMessages();
  }
}

/* ---------- å¼¹çª—é€»è¾‘ ---------- */
openSettingsBtn.addEventListener("click", ()=>{settingsModal.style.display="flex";});
closeSettingsBtn.addEventListener("click", ()=>{settingsModal.style.display="none";});
saveSettingsBtn.addEventListener("click", ()=>{
  saveSettings();
  settingsModal.style.display="none";
  renderMessages();
});

/* ---------- æ¸…ç©ºå†å² ---------- */
clearHistoryBtn.addEventListener("click", ()=>{
  if(confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ")){
    messages = [];
    localStorage.removeItem(STORAGE_KEY);
    renderMessages();
  }
});

/* ---------- å‘é€äº‹ä»¶ & è¾“å…¥é«˜åº¦ ---------- */
sendBtn.addEventListener("click", sendMessage);
inputEl.addEventListener("keydown", (e)=>{
  if((e.ctrlKey && e.key==="Enter") || (e.key==="Enter" && !e.shiftKey && !e.ctrlKey)){
    e.preventDefault();
    sendMessage();
  }
});
inputEl.addEventListener("input", ()=>{
  inputEl.style.height = "auto";
  inputEl.style.height = Math.min(inputEl.scrollHeight,240)+"px";
});

/* ---------- è§†è§‰è§†å£ï¼ˆVisualViewportï¼‰ç”¨äºå¤„ç†é”®ç›˜é«˜åº¦ï¼Œé¿å…é—´éš™ ---------- */
const BASE_BOTTOM_HEIGHT = 76; // ä¸ css :root --bottom-height åŸºç¡€ä¿æŒä¸€è‡´
function updateForViewport(){
  const vv = window.visualViewport;
  let kb = 0;
  if(vv){
    // è®¡ç®—é”®ç›˜é«˜åº¦ï¼šçª—å£å†…é«˜åº¦ï¼ˆinnerHeightï¼‰å‡å» visualViewport.heightï¼ˆå—é”®ç›˜å½±å“ï¼‰
    kb = Math.max(0, window.innerHeight - vv.height - (vv.offsetTop || 0));
  } else {
    // fallback: ä½¿ç”¨ window.innerHeight ä¸ document.documentElement.clientHeight ä¹‹å·®ï¼ˆæŸäº›æµè§ˆå™¨ï¼‰
    kb = Math.max(0, window.innerHeight - document.documentElement.clientHeight);
  }
  // è®¾ç½® bottom å…ƒç´ åº•éƒ¨é—´è·ï¼ˆå›ºå®šå®šä½ï¼‰ï¼Œå¹¶æ›´æ–° main çš„ padding-bottomï¼ˆé€šè¿‡ css å˜é‡ï¼‰
  bottomEl.style.bottom = (kb > 0 ? kb + 'px' : '0px');
  document.documentElement.style.setProperty('--bottom-height', `${BASE_BOTTOM_HEIGHT + kb}px`);
  // å½“è¾“å…¥æ¡†è·å–ç„¦ç‚¹æ—¶ç¡®ä¿æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆç»™ç§»åŠ¨ç«¯æ—¶é—´ï¼‰
  setTimeout(()=>{ const container = msgsEl.parentElement; container.scrollTop = container.scrollHeight; }, 120);
}

/* ç›‘å¬ visualViewport å˜åŒ–ï¼ˆå¤šæ•°ç§»åŠ¨ç«¯æµè§ˆå™¨æ”¯æŒï¼‰ï¼ŒåŠ resize */
if(window.visualViewport){
  window.visualViewport.addEventListener('resize', updateForViewport, {passive:true});
  window.visualViewport.addEventListener('scroll', updateForViewport, {passive:true});
}
window.addEventListener('resize', updateForViewport);
inputEl.addEventListener('focus', ()=>{
  setTimeout(()=>{ updateForViewport(); const container = msgsEl.parentElement; container.scrollTop = container.scrollHeight; }, 250);
});
inputEl.addEventListener('blur', ()=>{ setTimeout(updateForViewport, 160); });

/* fallback ä¿è¯åœ¨ load æ—¶æ­£ç¡®è®¾ç½® */
window.addEventListener("load", ()=>{
  loadSettings();
  headerTitleUpdate();
  renderMessages();
  updateForViewport();
});

/* å…¼å®¹ï¼šåœ¨è½¯é”®ç›˜å¼¹èµ·ååšä¸€æ¬¡æœ€ç»ˆæ»šåŠ¨ */
window.addEventListener('orientationchange', ()=> setTimeout(updateForViewport, 300));
</script>
</body>
</html>